# ~/beautybot/main.py
import asyncio
import logging
import os
from dotenv import load_dotenv

from aiogram import Bot, Dispatcher
from aiogram.enums import ParseMode
from aiogram.client.default import DefaultBotProperties

load_dotenv()

TOKEN = os.getenv("BOT_TOKEN")
if not TOKEN:
    raise RuntimeError("BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env. –î–æ–±–∞–≤—å BOT_TOKEN=... –≤ —Ñ–∞–π–ª .env")

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

async def main():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î (–µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –µ—Å—Ç—å)
    try:
        from app.utils.db import init_db
        await init_db()
        logger.info("‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
    except Exception as e:
        logger.warning("‚ö†Ô∏è init_db –æ—à–∏–±–∫–∞ (–µ—Å–ª–∏ DB —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞, –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å): %s", e)

    # —Å–æ–∑–¥–∞—ë–º –±–æ—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è aiogram>=3.7
    bot = Bot(token=TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
    dp = Dispatcher()

    # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã
    try:
        # –í–∞–∂–Ω–æ: –ø–æ–¥–∫–ª—é—á–∞–µ–º client_booking –≤–º–µ—Å—Ç–æ booking
        from app.handlers import start, client_booking, master_panel
        dp.include_router(start.router)
        dp.include_router(client_booking.router)
        dp.include_router(master_panel.router)
    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ —Ä–æ—É—Ç–µ—Ä–æ–≤: %s", e)
        raise

    logger.info("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Å–ª—É—à–∞–µ—Ç Telegram...")
    # handle_signals=False ‚Äî —É–¥–æ–±–Ω–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —á–µ—Ä–µ–∑ pm2/systemd
    await dp.start_polling(bot, handle_signals=False)

if __name__ == "__main__":
    asyncio.run(main())
